---
import { shopStyleService } from '@/services/ShopStyleService';
import { DatabaseService } from '@/lib/database';
import MenuFooter from './MenuFooter.astro';

const currentYear = new Date().getFullYear();

// Lấy shop alias từ subdomain
const url = new URL(Astro.request.url);
const host = url.hostname;
const shopAlias = host ? host.split('.')[0] : '';

// Lấy logo URL - Footer sử dụng secondary logo
let secondaryLogoUrl = null;
try {
  secondaryLogoUrl = await shopStyleService.getSecondaryLogoUrl(shopAlias);
} catch (error) {
  console.error('Error loading logo:', error);
}

// Load footer settings from database
let footerSettings = {
  showProductCategories: true,
  showCustomPages: true,
  footerText: `© ${currentYear} BigS. Tất cả quyền được bảo lưu.`
};

// Load categories and custom pages
let categories: any[] = [];
let customPages = [
  { name: 'Về chúng tôi', url: '/ve-chung-toi' },
  { name: 'Chính sách bảo mật', url: '/chinh-sach-bao-mat' },
  { name: 'Điều khoản sử dụng', url: '/dieu-khoan-su-dung' },
  { name: 'Liên hệ', url: '/lien-he' }
];

if (shopAlias) {
  try {
    const dbFooterSettings = await shopStyleService.getFooterSettings(shopAlias);
    if (dbFooterSettings) {
      footerSettings = {
        showProductCategories: dbFooterSettings.showProductCategories ?? true,
        showCustomPages: dbFooterSettings.showCustomPages ?? true,
        footerText: dbFooterSettings.footerText || `© ${currentYear} BigS. Tất cả quyền được bảo lưu.`
      };
    }
    
    // Load categories if needed
    if (footerSettings.showProductCategories) {
      try {
        const sections = await DatabaseService.getSectionsWithProducts(shopAlias);
        categories = Array.isArray(sections) 
          ? sections.map((section: any) => ({
              key: section.id.toString(),
              name: section.name,
              url: section.url,
              productCount: section.product_count || 0
            }))
          : [];
      } catch (error) {
        console.error('Error loading categories for footer:', error);
      }
    }
  } catch (error) {
    console.error('Error loading footer settings from database:', error);
  }
}
console.log('🔘 Footer settings:', footerSettings);
---

<footer class="bg-neutral text-white pt-12 pb-8">
  <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
         <MenuFooter 
       footerSettings={footerSettings} 
       categories={categories} 
       customPages={customPages}
       secondaryLogoUrl={secondaryLogoUrl || undefined}
     />
  </div>
</footer>